<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="uhuV0rnYMUWuzeZrPSHxh_QSZ6tM5AWsUD-fXyEVOOc">
  <meta name="baidu-site-verification" content="codeva-jBfPQBw271">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha256-wiz7ZSCn/btzhjKDQBms9Hx4sSeUYsDrTLg7roPstac=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-mac-osx.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.cnwangk.top","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.19.2","exturl":true,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"giscus","storage":true,"lazyload":true,"nav":null,"activeClass":"giscus"},"stickytabs":true,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":true,"preload":true}}</script><script src="/js/config.js"></script>

    <meta name="description" content="主要介绍内容有：MySQL锁介绍、InnoDB行锁、lock与latch区别、锁类型、一致性非锁（锁）定读；自增长与锁；外键与锁；锁的算法；阻塞、死锁以及锁升级。 我可以和面试官多聊几句吗？只是想…MySQL锁介绍以及InnoDB锁问题。﻿养成阅读官方文档，是一个良好的习惯。能编写官方文档，至少证明他们在这个领域是有很高的造诣，对用法足够熟练。 面试官：咦，小伙子，又来啦。 我：面试官，您好，又见">
<meta property="og:type" content="blog">
<meta property="og:title" content="MySQL锁问题InnoDB锁：行锁、lock与latch、外键与锁、锁算法以及死锁问题">
<meta property="og:url" content="https://blog.cnwangk.top/2022/04/07/MySQL%E9%94%81%E9%97%AE%E9%A2%98InnoDB%E9%94%81%EF%BC%9A%E8%A1%8C%E9%94%81%E3%80%81lock%E4%B8%8Elatch%E3%80%81%E5%A4%96%E9%94%AE%E4%B8%8E%E9%94%81%E3%80%81%E9%94%81%E7%AE%97%E6%B3%95%E4%BB%A5%E5%8F%8A%E6%AD%BB%E9%94%81%E9%97%AE%E9%A2%98/index.html">
<meta property="og:site_name" content="龙腾万里sky的博客">
<meta property="og:description" content="主要介绍内容有：MySQL锁介绍、InnoDB行锁、lock与latch区别、锁类型、一致性非锁（锁）定读；自增长与锁；外键与锁；锁的算法；阻塞、死锁以及锁升级。 我可以和面试官多聊几句吗？只是想…MySQL锁介绍以及InnoDB锁问题。﻿养成阅读官方文档，是一个良好的习惯。能编写官方文档，至少证明他们在这个领域是有很高的造诣，对用法足够熟练。 面试官：咦，小伙子，又来啦。 我：面试官，您好，又见">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://img-blog.csdnimg.cn/img_convert/9897445be9ccea40278b7827713ecfa6.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/7439166f7c74468e8ecb3f25391795ec.png#pic_center">
<meta property="og:image" content="https://img-blog.csdnimg.cn/img_convert/6876766c70e780b29d0fe31ef74f1509.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/img_convert/79de541a8ca6e2f447c7edd0ed0cf6f1.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/8018eeede19d432597ef6e5e49318029.png?x-oss-process=,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA6b6Z6IW-5LiH6YeMc2t5,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center">
<meta property="article:published_time" content="2022-04-06T16:00:00.000Z">
<meta property="article:modified_time" content="2023-09-25T14:50:40.369Z">
<meta property="article:author" content="龙腾万里sky">
<meta property="article:tag" content="MySQL">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img-blog.csdnimg.cn/img_convert/9897445be9ccea40278b7827713ecfa6.png">


<link rel="canonical" href="https://blog.cnwangk.top/2022/04/07/MySQL%E9%94%81%E9%97%AE%E9%A2%98InnoDB%E9%94%81%EF%BC%9A%E8%A1%8C%E9%94%81%E3%80%81lock%E4%B8%8Elatch%E3%80%81%E5%A4%96%E9%94%AE%E4%B8%8E%E9%94%81%E3%80%81%E9%94%81%E7%AE%97%E6%B3%95%E4%BB%A5%E5%8F%8A%E6%AD%BB%E9%94%81%E9%97%AE%E9%A2%98/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.cnwangk.top/2022/04/07/MySQL%E9%94%81%E9%97%AE%E9%A2%98InnoDB%E9%94%81%EF%BC%9A%E8%A1%8C%E9%94%81%E3%80%81lock%E4%B8%8Elatch%E3%80%81%E5%A4%96%E9%94%AE%E4%B8%8E%E9%94%81%E3%80%81%E9%94%81%E7%AE%97%E6%B3%95%E4%BB%A5%E5%8F%8A%E6%AD%BB%E9%94%81%E9%97%AE%E9%A2%98/","path":"2022/04/07/MySQL锁问题InnoDB锁：行锁、lock与latch、外键与锁、锁算法以及死锁问题/","title":"MySQL锁问题InnoDB锁：行锁、lock与latch、外键与锁、锁算法以及死锁问题"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>MySQL锁问题InnoDB锁：行锁、lock与latch、外键与锁、锁算法以及死锁问题 | 龙腾万里sky的博客</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">龙腾万里sky的博客</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">养得胸中一种恬静</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-links"><a href="/links/" rel="section"><i class="fa fa-globe fa-fw fa-fw"></i>友链</a></li><li class="menu-item menu-item-happy"><a href="/happy/" rel="section"><i class="fa fa-globe fa-fw fa-fw"></i>文娱</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#MySQL%E9%94%81%E9%97%AE%E9%A2%98%E2%80%93InnoDB%E8%A1%8C%E9%94%81"><span class="nav-number">1.</span> <span class="nav-text">MySQL锁问题–InnoDB行锁</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#MySQL%E9%94%81%E9%97%AE%E9%A2%98"><span class="nav-number">1.1.</span> <span class="nav-text">MySQL锁问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#01-MySQL%E9%94%81%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.1.1.</span> <span class="nav-text">01 MySQL锁介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-%E4%BB%80%E4%B9%88%E6%98%AF%E9%94%81"><span class="nav-number">1.1.1.1.</span> <span class="nav-text">1.1  什么是锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-MySQL%E9%94%81"><span class="nav-number">1.1.1.2.</span> <span class="nav-text">1.2  MySQL锁</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#02-InnoDB-%E9%94%81%E9%97%AE%E9%A2%98"><span class="nav-number">1.1.2.</span> <span class="nav-text">02 InnoDB 锁问题</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-%E8%A1%8C%E7%BA%A7%E9%94%81%E7%9A%84%E7%A5%9E%E8%AF%9D"><span class="nav-number">1.1.2.1.</span> <span class="nav-text">2.1  行级锁的神话</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-lock%E4%B8%8Elatch"><span class="nav-number">1.1.2.2.</span> <span class="nav-text">2.2  lock与latch</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-%E9%94%81%E7%B1%BB%E5%9E%8B"><span class="nav-number">1.1.2.3.</span> <span class="nav-text">2.3  锁类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-%E4%B8%80%E8%87%B4%E6%80%A7%E9%9D%9E%E9%94%81%EF%BC%88%E9%94%81%EF%BC%89%E5%AE%9A%E8%AF%BB"><span class="nav-number">1.1.2.4.</span> <span class="nav-text">2.4  一致性非锁（锁）定读</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-%E8%87%AA%E5%A2%9E%E9%95%BF%E4%B8%8E%E9%94%81"><span class="nav-number">1.1.2.5.</span> <span class="nav-text">2.5  自增长与锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-6-%E5%A4%96%E9%94%AE%E4%B8%8E%E9%94%81"><span class="nav-number">1.1.2.6.</span> <span class="nav-text">2.6  外键与锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-7-%E9%94%81%E7%9A%84%E7%AE%97%E6%B3%95"><span class="nav-number">1.1.2.7.</span> <span class="nav-text">2.7  锁的算法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-8-%E9%98%BB%E5%A1%9E%E3%80%81%E6%AD%BB%E9%94%81%E3%80%81%E9%94%81%E5%8D%87%E7%BA%A7"><span class="nav-number">1.1.2.8.</span> <span class="nav-text">2.8  阻塞、死锁、锁升级</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#03-MySQL%E5%AE%98%E6%96%B9%E7%A4%BA%E4%BE%8B%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-number">1.1.3.</span> <span class="nav-text">03  MySQL官方示例数据库</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%8E%AB%E9%97%AE%E6%94%B6%E8%8E%B7%EF%BC%8C%E4%BD%86%E9%97%AE%E8%80%95%E8%80%98"><span class="nav-number">2.</span> <span class="nav-text">莫问收获，但问耕耘</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="龙腾万里sky"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">龙腾万里sky</p>
  <div class="site-description" itemprop="description">AI & 过去现在未来</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">99</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">44</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2Nud2FuZ2s=" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;cnwangk"><i class="fab fa-github fa-fw"></i>GitHub</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS9oYndr" title="Zhihu → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;hbwk"><i class="fab fa-zhihu fa-fw"></i>Zhihu</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="bWFpbHRvOmR5d2FuZ2tAZ21haWwuY29t" title="E-Mail → mailto:dywangk@gmail.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</span>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <span class="exturl cc-opacity" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/big/by_nc_sa.svg" alt="Creative Commons"></span>
  </div>

        </div>
      </div>
    </div>

    
        <div class="sidebar-inner sidebar-post-related">
          <div class="animated">
              <div class="links-of-blogroll-title"><i class="fa fa-signs-post fa-fw"></i>
    相关文章
  </div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <a class="popular-posts-link" href="/2022/04/07/MySQL%E9%94%81%E9%97%AE%E9%A2%98%EF%BC%9AMyISAM%E5%8A%A0%E8%A1%A8%E9%94%81%E3%80%81%E5%B9%B6%E5%8F%91%E6%8F%92%E5%85%A5%E4%BB%A5%E5%8F%8A%E9%94%81%E8%B0%83%E5%BA%A6/" rel="bookmark">
        <time class="popular-posts-time">2022-04-07</time>
        <br>
      MySQL锁问题：MyISAM加表锁、并发插入以及锁调度
      </a>
    </li>
    <li class="popular-posts-item">
      <a class="popular-posts-link" href="/2022/04/07/MySQL%E4%BC%98%E5%8C%96%E6%B5%81%E7%A8%8B%EF%BC%9A%E4%BD%BF%E7%94%A8%E7%B4%A2%E5%BC%95%E5%85%B8%E5%9E%8B%E5%9C%BA%E6%99%AFAND%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88%E5%9C%BA%E6%99%AF/" rel="bookmark">
        <time class="popular-posts-time">2022-04-07</time>
        <br>
      MySQL优化流程：使用索引典型场景AND索引失效场景
      </a>
    </li>
  </ul>

          </div>
        </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.cnwangk.top/2022/04/07/MySQL%E9%94%81%E9%97%AE%E9%A2%98InnoDB%E9%94%81%EF%BC%9A%E8%A1%8C%E9%94%81%E3%80%81lock%E4%B8%8Elatch%E3%80%81%E5%A4%96%E9%94%AE%E4%B8%8E%E9%94%81%E3%80%81%E9%94%81%E7%AE%97%E6%B3%95%E4%BB%A5%E5%8F%8A%E6%AD%BB%E9%94%81%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="龙腾万里sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="龙腾万里sky的博客">
      <meta itemprop="description" content="AI & 过去现在未来">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="MySQL锁问题InnoDB锁：行锁、lock与latch、外键与锁、锁算法以及死锁问题 | 龙腾万里sky的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          MySQL锁问题InnoDB锁：行锁、lock与latch、外键与锁、锁算法以及死锁问题
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-04-07 00:00:00" itemprop="dateCreated datePublished" datetime="2022-04-07T00:00:00+08:00">2022-04-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-09-25 22:50:40" itemprop="dateModified" datetime="2023-09-25T22:50:40+08:00">2023-09-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>13k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>48 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>主要介绍内容有：MySQL锁介绍、InnoDB行锁、lock与latch区别、锁类型、一致性非锁（锁）定读；自增长与锁；外键与锁；锁的算法；阻塞、死锁以及锁升级。</p>
<p>我可以和面试官多聊几句吗？只是想…<br><strong>MySQL锁介绍以及InnoDB锁问题</strong>。﻿<strong>养成阅读官方文档</strong>，是一个良好的习惯。能编写官方文档，至少证明他们在这个领域是有很高的造诣，对用法足够熟练。</p>
<p><strong>面试官</strong>：咦，小伙子，又来啦。</p>
<p><strong>我</strong>：面试官，您好，又见面了。前面确实收获不少，我想……想获取更多的经验。</p>
<p><strong>面试官</strong>：不错，不错，不错，年纪轻轻，有我当年一半的风范，挺有觉悟。接着上次的话题，继续MySQL锁问题。</p>
<p><strong>我</strong>：好呀，这次我准备了InnoDB锁一些总结，希望您多多指教。</p>
<p><strong>面试官</strong>：那，让我们进入今天的话题，一起讨论MySQL锁问题。</p>
<p><strong>我</strong>：好的，请接着往下看。</p>
<p><strong>tips</strong>：图片资源可能被防盗链（寄）了，可以<strong>右键属性复制地址在地址栏查看</strong>哈。</p>
<span id="more"></span>

<p>如果没有进行特别说明，一般是基于MySQL8.0.28进行测试验证。</p>
<p><strong>友情提示：经验是用来参考，不是拿来即用</strong>。如果你能看到并分享这篇文章，我很荣幸。如果有误导你的地方，我表示抱歉。<br><img data-src="https://img-blog.csdnimg.cn/img_convert/9897445be9ccea40278b7827713ecfa6.png"></p>
<h1 id="MySQL锁问题–InnoDB行锁"><a href="#MySQL锁问题–InnoDB行锁" class="headerlink" title="MySQL锁问题–InnoDB行锁"></a>MySQL锁问题–InnoDB行锁</h1><p><strong>友情提示</strong>：在某些情况，你看到的结果可能与我演示有所不同，省略了部分参数。</p>
<p>如果你是从MySQL5.6或者5.7版本过渡到MySQL8.0。学习之前，建议线看官方文档这一章节：<strong>1.3 What Is New MySQL8.0</strong> 。在做对比的时候，<strong>文档中带有Note标识是你应该注意的地方</strong>。比如下面这张截图：</p>
<p><img data-src="https://img-blog.csdnimg.cn/7439166f7c74468e8ecb3f25391795ec.png#pic_center" alt="在这里插入图片描述"></p>
<h2 id="MySQL锁问题"><a href="#MySQL锁问题" class="headerlink" title="MySQL锁问题"></a>MySQL锁问题</h2><p><strong>简单概括锁</strong>：锁是计算机协调多个进程或线程并发访问某一资源的机制。</p>
<p>MySQL中的锁看上去用法和表面实现（对比其它DBMS），貌似很简单，但真正深入理解其实也不是那么容易。</p>
<h3 id="01-MySQL锁介绍"><a href="#01-MySQL锁介绍" class="headerlink" title="01 MySQL锁介绍"></a>01 MySQL锁介绍</h3><h4 id="1-1-什么是锁"><a href="#1-1-什么是锁" class="headerlink" title="1.1  什么是锁"></a>1.1  什么是锁</h4><p><strong>为何要使用锁</strong>？开发多用户、数据库驱动的应用时，难点（痛点）：一方面要最大程度地利用数据库的并发访问，另一方面还要<strong>确保每个用户能以一致的方式读取和修改数据</strong>。因此有了锁（locking）的机制，同时也是数据库系统区别于文件系统的一个关键特性。</p>
<p>在数据库中，除传统的计算资源（如CPU、RAM、I&#x2F;O等）的消耗外，数据也是一种供许多用户共享的资源。</p>
<p>如何保证数据并发访问的<strong>一致性</strong>、<strong>有效性</strong>是所有数据库必须解决的一个问题，<strong>锁冲突</strong>也是影响数据库并发访问性能的重要因素。从描述来看，锁对数据库显得尤为重要，也更加复杂。接下来，会对锁机制特点进行介绍、<strong>常见的锁问题</strong>，以及解决MySQL锁问题的方法。</p>
<h4 id="1-2-MySQL锁"><a href="#1-2-MySQL锁" class="headerlink" title="1.2  MySQL锁"></a>1.2  MySQL锁</h4><p>相比其它数据库来说，MySQL的锁机制相对好理解一点，其最显著的特点是不同的存储引擎支持不同锁机制。</p>
<p>比如MyISAM和MEMORY存储引擎采用表级锁（table-level locking）；BDB存储引擎（MySQL8.0文档没看到介绍）采用页面锁（page-level locking），但也支持表级锁（table-level locking）；InnoDB存储引擎既支持行级锁（row-level locking），也支持表级锁，默认采用行级锁。</p>
<p><strong>MySQL中3种锁特性</strong>：</p>
<ul>
<li>表级锁：开销小，加锁块。不会出现死锁，锁粒度大，发生锁冲突概率最高，并发度最低。</li>
<li>行级锁：开销大，加锁慢。会出现死锁，锁粒度最小，发生锁冲突概率最低，并发度最高。</li>
<li>页面锁：开销和加锁时间介于表锁与行锁之间。会出现死锁，锁粒度介于表锁与行锁之间，并发度一般。</li>
</ul>
<p>从上述各种锁特点来看，不能一概而论哪种锁更好，但可以<strong>从具体应用特点来判断哪种锁更合适</strong>。</p>
<p>单从锁角度出发：表锁较为适合以查询为主，少量按索引条件更新数据的应用。行级锁更适合有大量按索引条件、并发更新少量不同数据，同时有并发查询的应用。</p>
<h3 id="02-InnoDB-锁问题"><a href="#02-InnoDB-锁问题" class="headerlink" title="02 InnoDB 锁问题"></a>02 InnoDB 锁问题</h3><p><strong>ACID</strong>：在了解InnoDB锁问题之前，可以先看一下InnoDB存储引擎一些特性：简称ACID。</p>
<p>举个例子：（银行存钱，典型事务），正常情况：小芳去银行存钱，银行要么将钱存到系统并显示正常增长后的余额，要没全部回退出来。不正常情况：小芳存了一百大洋，银行将钱吞了，账户余额没变；或者小芳账户余额增加了，钱退回来了。</p>
<ol>
<li>原子性A（atomicity）：事务是一个原子操作单元，对数据的修改要么全执行，要么全不执行。</li>
<li>一致性C（consistency）：在事务开始和完成时，数据必须保持一致状态。</li>
<li>隔离性I（isolation）：数据库系统提供一定的隔离机制，保证事务在不受外部并发操作影响<strong>独立环境执行</strong>。</li>
<li>持久性D（durability）：事务完成之后，它对数据的修改是永久性的，即使出现系统故障也能保持。</li>
</ol>
<p><strong>并发事务处理带来的问题</strong>：</p>
<ol>
<li><strong>丢失更新</strong>（lost update）：当两个或多个事务选择同一行，然后基于最初选定的值更新该行时，由于每个事务都不知道其它事务的存在，就会发生丢失更新问题，最后的更新覆盖了由其它事务所做的更新。（可以想象多人在线编辑同一份文档，有多个版本控制，最后还原到锁问题上）</li>
<li><strong>脏读</strong>（dirty read）：一个事务正在对一条记录做修改，在这个事务完成并提交前，这条记录的数据就处于不一致状态；这时，另一个事务也来读取同一条记录，如果不加控制，第二个事务读取了这些“脏”数据，并作进一步处理，会产生未提交的数据依赖关系。这种现象被称为<strong>脏读</strong>。</li>
<li><strong>不可重复度</strong>（non-repeatable read）：一个事务在读取某些数据后的某个时间再次读取以前读过的数据，却发现其读过的数据已经发生了改变或某些记录已被删除。这种现象被称为<strong>不可重复读</strong>。</li>
<li><strong>幻读</strong>（phantom read）：一个事务按相同的查询条件重新读取以前检索过的数据，却发现其它事务插入了满足其查询条件的新数据，这种现象称为<strong>幻读</strong>。</li>
</ol>
<p><strong>脏读与不可重复读区别</strong>：脏读是读到<strong>未提交的数据</strong>，而不可重复度读到的是<strong>已经提交的数据</strong>。</p>
<p>更多MySQL8.0数据库的ACID模型介绍可以参考：</p>
<blockquote>
<p>15.2 InnoDB and the ACID Model</p>
</blockquote>
<h4 id="2-1-行级锁的神话"><a href="#2-1-行级锁的神话" class="headerlink" title="2.1  行级锁的神话"></a>2.1  行级锁的神话</h4><p>InnoDB存储引擎较MySQL数据库其它存储引擎在锁这一方面技高一筹，实现方式类似于Oracle数据库，提供一致性的非锁定读、行级锁支持。行锁没有相关额外开销，并可以同时得到并发性和一致性。</p>
<p><strong>行级锁</strong>的一个神话，锁总会增加开销。其实是这样的，当实现本身会增加开销时，行级锁才会增加开销。InnoDB不需要锁升级，因为一个锁和多个锁的开销是想同的。</p>
<p>对于MyISAM存储引擎，其锁是表锁设计。并发情况读没有问题，但是并发插入性能略微差了一些。如果插入在<strong>底部</strong>，MyISAM存储引擎还是有一定的并发写入操作的。这里重复介绍了，在介绍MyISAM表锁时也有提到过。</p>
<h4 id="2-2-lock与latch"><a href="#2-2-lock与latch" class="headerlink" title="2.2  lock与latch"></a>2.2  lock与latch</h4><p>MySQL数据库区分锁过程中，有一个容易令人混淆的概念lock与latch。在数据库中，lock与latch都被称为<strong>锁</strong>，但二者有截然不同的含义。</p>
<ol>
<li><strong>latch</strong>：一般称为闩（shuan）锁（轻量级的锁），因为其要求锁定的时间必须非常短。若持续时间长，则应用的性能会非常差。在InnoDB存储引擎中，latch又可以分为mutex（互斥量）和rwlock（读写锁）。其目的是用来保证<strong>并发线程操作临界资源的正确性</strong>，并且通常没有死锁检测的机制。</li>
<li><strong>lock</strong>：<strong>lock</strong>的对象是<strong>事务</strong>，<strong>用来锁定的是数据库中的对象</strong>，比如表、页、行。一般lock的对象仅在事务commit或rollback后进行释放，不同事务隔离级别释放的时间可能不同。此外，lock正如在大多数数据库中一样，是有死锁机制的。</li>
</ol>
<p>对于InnoDB存储引擎中的<strong>latch</strong>，可以通过命令查看：</p>
<p><strong>语法</strong>：SHOW ENGINE engine_name {STATUS | MUTEX}</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> engine innodb mutex;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------+----------------------------+-------------+</span></span><br><span class="line"><span class="operator">|</span> Type   <span class="operator">|</span> Name                       <span class="operator">|</span> Status      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+----------------------------+-------------+</span></span><br><span class="line"><span class="operator">|</span> InnoDB <span class="operator">|</span> rwlock: fil0fil.cc:<span class="number">3360</span>    <span class="operator">|</span> waits<span class="operator">=</span><span class="number">6</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> InnoDB <span class="operator">|</span> rwlock: dict0dict.cc:<span class="number">2508</span>  <span class="operator">|</span> waits<span class="operator">=</span><span class="number">4</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> InnoDB <span class="operator">|</span> sum rwlock: buf0buf.cc:<span class="number">787</span> <span class="operator">|</span> waits<span class="operator">=</span><span class="number">40351</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+----------------------------+-------------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>13.7.7.15 SHOW ENGINE Statement</p>
</blockquote>
<p><strong>tips</strong>：在debug版本中，可以查看到status参数的更多信息。</p>
<h4 id="2-3-锁类型"><a href="#2-3-锁类型" class="headerlink" title="2.3  锁类型"></a>2.3  锁类型</h4><p><strong>锁类型列表（InnoDB Locking）</strong>：</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>InnoDB Locking</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>标准行级锁共享锁和排它锁（Shared and Exclusive Locks）</td>
</tr>
<tr>
<td>2</td>
<td>记录锁（Record Locks）</td>
</tr>
<tr>
<td>3</td>
<td>间隙锁（Gap Locks）</td>
</tr>
<tr>
<td>4</td>
<td>Next-Key Locks</td>
</tr>
<tr>
<td>5</td>
<td>插入意图锁（Insert Intention Locks）</td>
</tr>
<tr>
<td>6</td>
<td>AUTO-INC Locks</td>
</tr>
<tr>
<td>7</td>
<td>空间索引谓词锁（Predicate Locks for Spatial Indexes）</td>
</tr>
</tbody></table>
<p>虽然上面列出了7种锁，但下面只介绍标准行级锁和意向锁，其它锁类型介绍可以参考MySQL8.0官方文档。</p>
<p><strong>InnoDB存储引擎</strong>实现了以下两种类型<strong>标准行级锁</strong>：</p>
<ol>
<li><strong>共享锁</strong>（S Lock）：允许事务读一行数据。</li>
<li><strong>排它锁</strong>（X Lock）：允许事务删除或更新一行数据。</li>
</ol>
<p>如果一个事务T1持有行r上的一个共享(S)锁，那么来自不同事务T2的请求对行r上的一个锁处理如下:</p>
<ol>
<li>T2对共享锁（S）的请求可以立即被授予（获得行r共享锁）。因此，T1和T2都对行r保持S锁定。</li>
<li>T2对排它锁（X）锁请求不能立即授予。</li>
</ol>
<p>其它事务想获得行r共享锁，其它请求等待T1、T2释放共享锁。</p>
<p>如果事务T1持有行r上的排它(X)锁，那么来自不同事务T2对行r上任何一种类型的锁请求都不能立即被授予。相反，事务T2必须等待事务T1释放其对行r的锁。</p>
<p><strong>两种标准行级锁兼容性如下表格所示</strong>：</p>
<table>
<thead>
<tr>
<th></th>
<th>X（排它锁）</th>
<th>S（共享锁）</th>
</tr>
</thead>
<tbody><tr>
<td>X（排它锁）</td>
<td>Conflict（不兼容）</td>
<td>Conflict（不兼容）</td>
</tr>
<tr>
<td>S（共享锁）</td>
<td>Conflict（不兼容）</td>
<td>Compatible（兼容）</td>
</tr>
</tbody></table>
<p>从上面表格中可以发现X锁与任何锁都不兼容，而S锁仅与S锁兼容。</p>
<p><strong>注意</strong>：S和X锁是<strong>行锁</strong>，<strong>兼容指对同一行记录</strong>（row）<strong>锁兼容性</strong>情况。</p>
<p>除此之外，InnoDB存储引擎支持多粒度（<strong>granularity</strong>）锁定，这种锁定<strong>允许事务在行级上的锁和表级上的锁同时存在</strong>。为了支持在不同粒度上进行加锁操作，InnoDB存储引擎支持一种额外的锁方式，称为意向锁（<strong>Intention Locks</strong>）。意向锁将锁定的对象分为多个层次，意味着事务希望在更加细粒度（fine granularity）上加行锁。如下图3-3所示：</p>
<p><img data-src="https://img-blog.csdnimg.cn/img_convert/6876766c70e780b29d0fe31ef74f1509.png"></p>
<p>如果将上锁的对象看成一棵树，那么对最下层的对象上锁，也就是对最细粒度对象进行上锁，首先需要对粗粒度对象上锁。</p>
<p>InnoDB存储引擎支持意向锁设计比较简练，其意向锁为表级别锁。设计目的是为了在一个事务中揭示下一行将被请求的锁类型，支持如下两种意向锁。</p>
<p><strong>意向锁</strong>（Intention Locks）：</p>
<ol>
<li>意向共享锁（IS）：事务想要获得一张表中某几行的共享锁。</li>
<li>意向排它锁（IX）：事务想要获得一张表中某几行的排它锁。</li>
</ol>
<p>由于InnoDB存储引擎支持的是行级别锁，因此意向锁不会阻塞除全表扫描以外的任何请求。</p>
<p><strong>表级锁与行级锁类型兼容性汇总在如下面表格所示</strong>，并使用中文进行标注：</p>
<table>
<thead>
<tr>
<th></th>
<th>X（排它锁）</th>
<th>IX（意向排它锁）</th>
<th>S（共享锁）</th>
<th>IS（意向共享锁）</th>
</tr>
</thead>
<tbody><tr>
<td>X（排它锁）</td>
<td>Conflict（不兼容）</td>
<td>Conflict（不兼容）</td>
<td>Conflict（不兼容）</td>
<td>Conflict（不兼容）</td>
</tr>
<tr>
<td>IX（意向排它锁）</td>
<td>Conflict（不兼容）</td>
<td>Compatible（兼容）</td>
<td>Conflict（不兼容）</td>
<td>Compatible（兼容）</td>
</tr>
<tr>
<td>S（共享锁）</td>
<td>Conflict（不兼容）</td>
<td>Conflict（不兼容）</td>
<td>Compatible（兼容）</td>
<td>Compatible（兼容）</td>
</tr>
<tr>
<td>IS（意向共享锁）</td>
<td>Conflict（不兼容）</td>
<td>Compatible（兼容）</td>
<td>Compatible（兼容）</td>
<td>Compatible（兼容）</td>
</tr>
</tbody></table>
<p>用户可以通过命令<code>show engine innodb status</code>查看<strong>当前锁请求信息</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> engine innodb status\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">  Type: InnoDB</span><br><span class="line">  Name:</span><br><span class="line">Status:</span><br><span class="line"><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span></span><br><span class="line"><span class="number">2022</span><span class="number">-03</span><span class="number">-23</span> <span class="number">22</span>:<span class="number">16</span>:<span class="number">07</span> <span class="number">0x32d0</span> INNODB MONITOR OUTPUT</span><br><span class="line"><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span></span><br><span class="line"><span class="keyword">Per</span> <span class="keyword">second</span> averages calculated <span class="keyword">from</span> the <span class="keyword">last</span> <span class="number">15</span> seconds</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">------------</span></span><br><span class="line">TRANSACTIONS</span><br><span class="line"><span class="comment">------------</span></span><br><span class="line">Trx id counter <span class="number">16145</span></span><br><span class="line">Purge done <span class="keyword">for</span> trx<span class="string">&#x27;s n:o &lt; 16144 undo n:o &lt; 0 state: running but idle</span></span><br><span class="line"><span class="string">History list length 0</span></span><br><span class="line"><span class="string">LIST OF TRANSACTIONS FOR EACH SESSION:</span></span><br><span class="line"><span class="string">---TRANSACTION 283762070116728, not started</span></span><br><span class="line"><span class="string">0 lock struct(s), heap size 1128, 0 row lock(s)</span></span><br><span class="line"><span class="string">---TRANSACTION 283762070115952, not started</span></span><br><span class="line"><span class="string">0 lock struct(s), heap size 1128, 0 row lock(s)</span></span><br><span class="line"><span class="string">---TRANSACTION 16144, ACTIVE 237 sec starting index read</span></span><br><span class="line"><span class="string">mysql tables in use 1, locked 1</span></span><br><span class="line"><span class="string">LOCK WAIT 2 lock struct(s), heap size 1128, 2 row lock(s)</span></span><br><span class="line"><span class="string">MySQL thread id 1249, OS thread handle 12132, query id 15048 localhost ::1 root statistics</span></span><br><span class="line"><span class="string">select * from world.city where id=1 for update</span></span><br><span class="line"><span class="string">------- TRX HAS BEEN WAITING 3 SEC FOR THIS LOCK TO BE GRANTED:</span></span><br><span class="line"><span class="string">RECORD LOCKS space id 28 page no 6 n bits 248 index PRIMARY of table `world`.`city` trx id 16144 lock_mode X locks rec but not gap waiting</span></span><br><span class="line"><span class="string">Record lock, heap no 2 PHYSICAL RECORD: n_fields 7; compact format; info bits 0</span></span><br><span class="line"><span class="string"> 0: len 4; hex 80000001; asc ;;</span></span><br><span class="line"><span class="string"> 1: len 6; hex 0000000016c9; asc ;;</span></span><br><span class="line"><span class="string"> 2: len 7; hex 81000001410110; asc     A  ;;</span></span><br><span class="line"><span class="string"> 3: len 30; hex 4b6162756c20202020202020202020202020202020202020202020202020; asc Kabul                         ; (total 35 bytes);</span></span><br><span class="line"><span class="string"> 4: len 3; hex 414647; asc AFG;;</span></span><br><span class="line"><span class="string"> 5: len 20; hex 4b61626f6c202020202020202020202020202020; asc Kabol ;;</span></span><br><span class="line"><span class="string"> 6: len 4; hex 801b2920; asc   ) ;;</span></span><br><span class="line"><span class="string">------------------</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">============================</span></span><br><span class="line"><span class="string">END OF INNODB MONITOR OUTPUT</span></span><br><span class="line"><span class="string">============================</span></span><br><span class="line"><span class="string">... </span></span><br><span class="line"><span class="string">1 row in set (0.00 sec)</span></span><br></pre></td></tr></table></figure>

<p>此处，主要截取了事务相关参数，其它参数省略掉了。如何看到事务锁具体信息，<strong>可以手动去加锁测试，制造一个场景</strong>。</p>
<p><strong>示例用法</strong>：</p>
<p>前提使用时InnoDB类型表做测试，可以使用<code>show create table table_name</code>查询当前表存储引擎。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> world.city\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">       <span class="keyword">Table</span>: city</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">Table</span>: <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `city` (</span><br><span class="line">  `ID` <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `Name` <span class="type">char</span>(<span class="number">35</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  `CountryCode` <span class="type">char</span>(<span class="number">3</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  `District` <span class="type">char</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  `Population` <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`ID`),</span><br><span class="line">  KEY `CountryCode` (`CountryCode`),</span><br><span class="line">  <span class="keyword">CONSTRAINT</span> `city_ibfk_1` <span class="keyword">FOREIGN</span> KEY (`CountryCode`) <span class="keyword">REFERENCES</span> `country` (`Code`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">4080</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_0900_ai_ci</span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>


<p>MySQL8.0中使用<code>select @@autocommit</code>查看到默认值是1，代表开启了自动提交。测试使用时建议通过 <code>set autocommit=0</code> 命令先关闭自动提交，或者手动控制事务（begin、start transaction）。详细示例不列举了，可以参考前面SQL优化步骤进行测试。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">begin</span></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> ... LOCK <span class="keyword">IN</span> SHARE MODE <span class="comment">-- 给语句加上共享锁</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> world.city <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span> lock <span class="keyword">in</span> share mode; <span class="comment">-- 示例给city表加上共享锁</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> ... <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>     <span class="comment">-- 给语句加上排它锁</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> world.city <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span> <span class="keyword">for</span> <span class="keyword">update</span>;  <span class="comment">-- 示例获取排它锁，超时会抛异常</span></span><br><span class="line">ERROR <span class="number">1205</span> (HY000): Lock wait timeout exceeded; try restarting transaction</span><br></pre></td></tr></table></figure>

<p>上面打印出来参数有很多，线程（BACKGROUND THREAD）、信号量（SEMAPHORES）、<strong>事务</strong>（<strong>TRANSACTIONS</strong>）、文件I&#x2F;O（FILE I&#x2F;O）、插入缓存和适配HASH索引（INSERT BUFFER AND ADAPTIVE HASH INDEX）、缓冲日志检查点（LOG）、缓冲池和内存（BUFFER POOL AND MEMORY）以及行操作（ROW OPERATIONS）。</p>
<p>个人感觉有必要说明一下缓存（cache）与缓冲（buffer）区别：</p>
<ul>
<li>缓冲（buffer）：加速数据写入硬盘；</li>
<li>缓存（cache）：加速数据从硬盘读取。</li>
</ul>
<p><strong>在MySQL8.0之前的版本information_schema</strong>架构下可以通过三张表：<code>INNODB_TRX</code>、<code>INNODB_LOCKS</code>、<code>INNODB_LOCK_WAITS</code>监控当前事务并分析可能存在的锁问题。</p>
<p><strong>友情提示</strong>：在5.6.x和5.7.x和MariaDB 10.5.6还能看到<code>INNODB_LOCKS</code>、<code>INNODB_LOCK_WAITS</code>；在MySQL8.0中已经移除，可以说换成另一种形式呈现：在<strong>performance_schema</strong>架构下有<strong>data_lock_waits</strong>、<strong>data_locks</strong>可以查询参考。</p>
<p><strong>INNODB_LOCKS</strong>与<strong>data_locks</strong>参数变化：<strong>有变化的参数加粗显示</strong></p>
<table>
<thead>
<tr>
<th>INNODB_LOCKS Column（参数）</th>
<th>data_locks Column（参数）</th>
</tr>
</thead>
<tbody><tr>
<td>LOCK_ID</td>
<td><strong>ENGINE_LOCK_ID</strong>：锁的ID</td>
</tr>
<tr>
<td>LOCK_TRX_ID</td>
<td><strong>ENGINE_TRANSACTION_ID</strong>：存储引擎事务ID</td>
</tr>
<tr>
<td>LOCK_MODE</td>
<td>LOCK_MODE：锁模式</td>
</tr>
<tr>
<td>LOCK_TYPE</td>
<td>LOCK_TYPE：锁类型</td>
</tr>
<tr>
<td>LOCK_TABLE (combined schema&#x2F;table names)</td>
<td><strong>OBJECT_SCHEMA</strong> (schema name), OBJECT_NAME<br/>(table name)：要加锁的表</td>
</tr>
<tr>
<td>LOCK_INDEX</td>
<td>LOCK_INDEX：锁住的索引</td>
</tr>
<tr>
<td>LOCK_SPACE：锁对象space id</td>
<td><strong>None</strong></td>
</tr>
<tr>
<td>LOCK_PAGE：事务锁定页数量</td>
<td><strong>None</strong></td>
</tr>
<tr>
<td>LOCK_REC：事务锁定行数量</td>
<td><strong>None</strong></td>
</tr>
<tr>
<td>LOCK_DATA</td>
<td>LOCK_DATA：事务锁定记录主键值</td>
</tr>
</tbody></table>
<p><strong>INNODB_LOCK_WAITS</strong>与<strong>data_lock_waits</strong>参数变化：<strong>有变化的参数加粗显示</strong></p>
<table>
<thead>
<tr>
<th>INNODB_LOCK_WAITS Column（参数）</th>
<th>data_lock_waits Column（参数）</th>
</tr>
</thead>
<tbody><tr>
<td>REQUESTING_TRX_ID：申请锁事务ID</td>
<td><strong>REQUESTING_ENGINE_TRANSACTION_ID</strong></td>
</tr>
<tr>
<td>REQUESTED_LOCK_ID：申请锁ID</td>
<td><strong>REQUESTING_ENGINE_LOCK_ID</strong></td>
</tr>
<tr>
<td>BLOCKING_TRX_ID：阻塞事务ID</td>
<td><strong>BLOCKING_ENGINE_TRANSACTION_ID</strong></td>
</tr>
<tr>
<td>BLOCKING_LOCK_ID：阻塞锁ID</td>
<td><strong>BLOCKING_ENGINE_LOCK_ID</strong></td>
</tr>
</tbody></table>
<p>如果命令字符界面查看不方便，可以借助客户端工具MySQL workbench或者SQLyog等等进行查看。</p>
<p>更多参数详细介绍，可以参考MySQL8.0官方文档进行查看测试。</p>
<p>同样可以使用其它命令查看InnoDB存储引擎信息：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> ENGINE INNODB MUTEX\G</span><br><span class="line"><span class="keyword">SHOW</span> ENGINE PERFORMANCE_SCHEMA STATUS\G   <span class="comment">-- 打印所有PERFORMANCE_SCHEMA状态信息</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">  Type: performance_schema</span><br><span class="line">  Name: events_waits_current.size</span><br><span class="line">Status: <span class="number">168</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">  Type: performance_schema</span><br><span class="line">  Name: events_waits_current.count</span><br><span class="line">Status: <span class="number">1536</span></span><br><span class="line">...</span><br><span class="line"><span class="number">248</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>以上是对锁类型进行简单介绍，理论知识偏多，基本结合MySQL8.0进行说明。</p>
<h4 id="2-4-一致性非锁（锁）定读"><a href="#2-4-一致性非锁（锁）定读" class="headerlink" title="2.4  一致性非锁（锁）定读"></a>2.4  一致性非锁（锁）定读</h4><p><strong>2.4.1 一致性非锁定读</strong></p>
<p>查询默认事务隔离级别 <code>tx_isolation</code>和<code>tx_read_only</code>系统参数已经在MySQL8.0.3中移除掉了，MySQL5.x和MariaDB10.5.6版本还可以继续使用<code>tx_isolation</code>这个系统参数。</p>
<p><strong>注意</strong>：新版MySQL8.0.3之后使用<code>transaction_isolation</code>和<code>transaction_read_only</code>替代。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> @<span class="variable">@tx_isolation</span>;  <span class="comment">-- MySQL5.x版本可以继续用</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> @<span class="variable">@transaction_isolation</span>;  <span class="comment">-- MySQL8.0.3版本开始使用新的系统参数</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@transaction_isolation</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+</span></span><br><span class="line"><span class="operator">|</span> REPEATABLE<span class="operator">-</span>READ         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>你可以参考文档：15.7.2.3 Consistent Nonlocking Reads</p>
<p>一致性非锁定读（<strong>Consistent Nonlocking Reads</strong>）是指InnoDB存储引擎通过多版本控制（<strong>multi-versioning</strong> ）的方式来读取当前执行时间数据库中行的数据。如果读取的行正在执行 DELETE 或 UPDATE操作，这时读取操作不会因此去等待行上的锁释放。相反，InnoDB存储引擎会读取一个快照数据。如图：3-4所示</p>
<p><img data-src="https://img-blog.csdnimg.cn/img_convert/79de541a8ca6e2f447c7edd0ed0cf6f1.png"></p>
<p>图3-4直观地展现了InnoDB存储引擎非锁定一致性读。<strong>之所以称其为非锁定读</strong>：因为不需要等待访问行上X锁的释放。快照数据是指该行之前版本的数据，该实现是通过undo段来完成。而undo用来在事务中回滚数据，因此<strong>快照数据本身是没有开销</strong>的。此外，<strong>读取快照数据是不需要上锁的</strong>，因为没有事务需要对历史数据进行修改操作。</p>
<p>可以看出，锁定读机制极大地提高了数据库的并发性。在InnoDB存储引擎默认设置下，这也是默认读取方式，即读取不会占用和等待表上的锁。但在不同事务隔离级别下，读取方式不同，并不是在每个事务隔离级别下都采用非锁定一致性读。即使是使用非锁定一致性读，对于快照数据定义也各不相同。</p>
<p>通过图3-4可以知道，快照数据其实是当前行数据之前的历史版本，每行记录可能有多个版本。如图3-4所示，一个行记录可能不止一个快照数据，一般称这种技术为行多版本技术。由此带来的并发控制，称之为多版本并发控制（multi-version concurrency control (MVCC)）。</p>
<p>在事务隔离级别 <strong>READ-COMMITTED</strong>和<strong>REPEATABLE-READ</strong>（InnoDB存储引擎默认事务隔离级别）下，InnoDB存储引擎使用非锁定一致性读。然而，对于快照数据定义却不相同。在READ-COMMITTED事务隔离级别下，对于快照数据，非一致性读总是读取事务开始时的行数据版本。</p>
<p><strong>如下示例，在两session A和session B会话中进行对比。在模拟并发过程中，希望带着思考去测试，不然会晕乎乎的</strong></p>
<p>前提设置事务非自动提交，或者手动开启事务，前面演示也多次提到过。关键字大小写不影响使用，个人使用统一规则就好。</p>
<p>修改事务隔离级（当前会话生效），便于测试：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> transaction_isolation<span class="operator">=</span><span class="string">&#x27;READ-COMMITTED&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> @<span class="variable">@transaction_isolation</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@transaction_isolation</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+</span></span><br><span class="line"><span class="operator">|</span> READ<span class="operator">-</span>COMMITTED          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>



<p><strong>session A</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- session A</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">begin</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> parent <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>



<p>会话A中已通过显示地执行命令BEGIN开启了一个事务，并读取parent表中id&#x3D;1的这条数据，但事务并没有结束。与此同时用户再开启另一个会话B，可以模拟出并发场景，然后对session B做如下操作。</p>
<p><strong>session B</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- session B</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">begin</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> parent <span class="keyword">set</span> id<span class="operator">=</span><span class="number">7</span> <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"><span class="keyword">Rows</span> matched: <span class="number">1</span>  Changed: <span class="number">1</span>  Warnings: <span class="number">0</span></span><br></pre></td></tr></table></figure>



<p>在会话B中将parent表id为1字段值记录修改为id&#x3D;7，但事务同样未提交，此时id&#x3D;1的行加了一个X锁。如果在会话A中再次读取id&#x3D;1的记录，根据InnoDB存储引擎特性，即在<code>READ-COMMITTED</code>和<code>REPEATABLE-READ</code>事务隔离级别下会使用非锁定一致性读。此时，再回到会话A中，继续未提交的事务，执行SQL语句：<code>select * from parent where id=1;</code>操作，不管使用READ-COMMITTED还是REPEATABLE-READ事务隔离级别，显示数据应该是：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> parent <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>



<p>由于当前id&#x3D;1的数据被修改了1次，因此只有一个行版本记录。接着会话2未提交的事务，提交事务：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- session B</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>



<p>会话B提交事务后，会话1再次执行<code>select * from parent where id=1;</code>SQL语句，在<code>READ-COMMITTED</code>和<code>REPEATABLE-READ</code>事务隔离级别下得到结果就不一样了。对于READ-COMMITTED事务隔离级别，它总是读取该行版本最新一个快照（fresh snapshot）。在上述示例中，因为会话B已经提交事务，所以READ-COMMITTED事务隔离级别下会得到如下结果：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> @<span class="variable">@transaction_isolation</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@transaction_isolation</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+</span></span><br><span class="line"><span class="operator">|</span> READ<span class="operator">-</span>COMMITTED          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> parent <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>



<p>对于REPEATABLE-READ（默认事务隔离级别），<strong>总是读取事务开始时的行数据</strong>。此时将session A和session B步骤对调来操作。起初我看文档时，也误解了，多研读几次才明白。<strong>得到示例结果如下</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> @<span class="variable">@transaction_isolation</span>;  </span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@transaction_isolation</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+</span></span><br><span class="line"><span class="operator">|</span> REPEATABLE<span class="operator">-</span>READ         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> parent <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>梳理一下session A和session B执行步骤，<strong>从时间角度演示</strong>：</p>
<table>
<thead>
<tr>
<th>时间（time）</th>
<th>session A</th>
<th>session B</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>BEGIN;</td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>SELECT * FROM parent WHERE id&#x3D;1;</td>
<td></td>
</tr>
<tr>
<td>3</td>
<td></td>
<td>BEGIN;</td>
</tr>
<tr>
<td>4</td>
<td></td>
<td>UPDATE parent SET id&#x3D;7 WHERE id&#x3D;1;</td>
</tr>
<tr>
<td>5</td>
<td>SELECT * FROM parent WHERE id&#x3D;1;</td>
<td></td>
</tr>
<tr>
<td>6</td>
<td></td>
<td>COMMIT;</td>
</tr>
<tr>
<td>7</td>
<td>SELECT * FROM parent WHERE id&#x3D;1;</td>
<td></td>
</tr>
<tr>
<td>8</td>
<td>COMMIT;</td>
<td></td>
</tr>
</tbody></table>
<p><strong>tips</strong>：测试时使用BEGIN显示开启也行，使用SET AUTOCOMMIT&#x3D;0同样也行。因为AUTOCOMMIT默认是1，所以手动禁止自动提交。</p>
<p><strong>2.4.2 一致性锁定读</strong></p>
<blockquote>
<p>15.7.2.4 Locking Reads</p>
</blockquote>
<p>默认配置下，事务隔离级别为REPEATABLE-READ模式下，InnoDB存储引擎的select操作使用一致性非锁定读。但在某种场景下，用户需要显示地对数据库读取操作进行加锁以保证数据逻辑一致性。需要数据库支持加锁语句，即使是对select的只读操作。InnoDB存储引擎对select语句支持两种一致性锁定读（locking reads ）</p>
<ul>
<li>SELECT … FOR UPDATE</li>
<li>SELECT … LOCK IN  SHARE MODE</li>
</ul>
<p><strong>注意</strong>：在MySQL8.0.22可以使用SELECT … FOR SHARE替代SELECT … LOCK IN  SHARE MODE，但是SELECT … LOCK IN  SHARE MODE是向后兼容，这两个描述是相同的。然而，使用FOR SHARE支持table_name, NOWAIT（不等待），和越过LOCKED选项。</p>
<p><code>SELECT ... FOR UPDATE</code>对读取的行记录加一个X锁，其它事务不能对已锁定的行加任何锁。<code>SELECT ... LOCK IN  SHARE MODE</code>对读取的行记录加上一个S锁，其它事务可以向被锁定的行加S锁，但如果是X锁，则会被阻塞。</p>
<p>对于一致性非锁定读，即使读取的行已被执行<code>SELECT ... FOR UPDATE</code>，也是可以进行读取的。此外，<code>SELECT ... FOR UPDATE</code>和<code>SELECT ... LOCK IN  SHARE MODE</code>必须在一个事务中，当事务提交了，锁也就释放了。因此在使用上述两句select锁定语句时，务必加上begin，使用start transaction要设置set autocommit&#x3D;0。<strong>前面也提到过autocommit值为0代表禁用自动提交</strong>。</p>
<h4 id="2-5-自增长与锁"><a href="#2-5-自增长与锁" class="headerlink" title="2.5  自增长与锁"></a>2.5  自增长与锁</h4><p>自增长在数据库中是非常常见的一种属性，也是很多DBA或开发人员首选的主键方式。在InnoDB存储引擎内存结构中，对每个含有自增长值的表都有一个自增长计数器（auto-increment counter）。对含有自增长的极计数器的表进行插入操作时，这个计数器会被初始化，执行如下语句得到计数器的值：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">MAX</span>(auto_inc_col) <span class="keyword">from</span> tbl_name <span class="keyword">for</span> <span class="keyword">update</span>;</span><br></pre></td></tr></table></figure>

<p>插入操作会依据这个自增长的计数器值加1赋予自增长列。这种实现方式称作<code>AUTO-INC Locks</code>。这种锁其实是一个特殊的表锁机制，为了提高插入性能，锁不是在一个事务完成后才释放，而是在完成对自增长值插入的SQL语句后立即释放。</p>
<p>虽然<code>AUTO-INC Locks</code>从一定程度上提高了并发插入的效率，但还是存在一些性能上的问题。对于有自增长值的列并发插入性能较差，事务必须等待前一个插入的完成（不用等待事务的完成）。此外，对于insert … select 的大数据量的插入会影响插入性能，因为另一个事务中的插入会被阻塞。</p>
<p>从MySQL5.1.22版本开始，InnoDB存储引擎提供了一种轻量级互斥量的自增长实现机制，这种机制大大提高了自增长值插入的性能。并且该版本开始，InnoDB存储引擎提供了一个参数<code>innodb_autoinc_lock_mode</code>来 控制自增长模式，该参数默认值为2（MySQL8.0）。一共有三个参数值可以设置，分别为（0、1、2），MySQL5.7默认值为1，MariaDB10.5.6版本默认也是1。</p>
<p>MySQL8.0查询<code>innodb_autoinc_lock_mode</code>默认值：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> @<span class="variable">@innodb_autoinc_lock_mode</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@innodb_autoinc_lock_mode</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------+</span></span><br><span class="line"><span class="operator">|</span>                          <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p><strong>自增长类型</strong>：</p>
<ol>
<li>INSERT-like：有<code>INSERT, INSERT ... SELECT，REPLACE， REPLACE ... SELECT，LOAD DATA</code>等。包含 simple-inserts，bulk-inserts以及mixed-mode inserts</li>
<li>Simple inserts：有 <code>INSERT</code> 和 <code>REPLACE</code>，不包含<code>INSERT ... ON DUPLICATE KEY UPDATE</code>。</li>
<li>Bulk inserts：有<code>INSERT ... SELECT，REPLACE ...SELECT，and LOAD DATA</code> 。</li>
<li>Mixed-mode inserts：出入中有一部分是自增长的，有一部分是确定的。比如：INSERT INTO t1 (c1,c2) VALUES (1,’a’), (NULL,’b’), (5,’c’), (NULL,’d’)；也可以是 <code>INSERT ... ON DUPLICATE KEY UPDATE</code>。</li>
</ol>
<p><strong>自增长分类</strong>，一共有三个参数值可以设置，分别为（0、1、2）：</p>
<ol>
<li>innodb_autoinc_lock_mode&#x3D;2：默认值为2。对于所有<code>INSERT-like</code>自增长值的产生都是通过互斥量，而不是AUTO-INC Locks方式。使用row-base replication，保证最大并发性能以及数据一致性，MySQL8.0推荐设置。包含 simple-inserts，bulk-inserts以及<br>mixed-mode inserts。</li>
<li>innodb_autoinc_lock_mode&#x3D;1：默认值为1。对于simple-inserts，该值会用互斥量去对内存的计数器进行累加操作。对于bulk-inserts，是使用传统表锁的AUTO-INC Locks方式。</li>
<li>innodb_autoinc_lock_mode&#x3D;0（traditional lock mode）：老版数据库传统锁模式。</li>
</ol>
<p><strong>注意</strong>：InnoDB存储引擎中自增长实现与MyISAM存储引擎不同，MyISAM是表锁设计，自增长不用考虑插入问题。在某种场景下，主节点（master）使用InnoDB存储引擎，在子节点（slave）使用MyISAM存储引擎的replication架构，用户需要考虑这种情况。</p>
<p>此外，在InnoDB存储引擎中，<strong>自增长值的列必须是索引</strong>，同时必须是索引的第一个列。如果不是第一个列，MySQL数据库则会抛异常，而MyISAM存储引擎没有这个问题。</p>
<p><strong>进行示例演示</strong>：出现1075异常，正常情况是c1在前，c2在后即可执行成功。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t1 (</span><br><span class="line">c1 <span class="type">INT</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">c2 <span class="type">VARCHAR</span>(<span class="number">10</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">KEY (c2,c1)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB;</span><br><span class="line">ERROR <span class="number">1075</span> (<span class="number">42000</span>): Incorrect <span class="keyword">table</span> definition; there can be <span class="keyword">only</span> <span class="keyword">one</span> auto <span class="keyword">column</span> <span class="keyword">and</span> it must be defined <span class="keyword">as</span> a key</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t1 (</span><br><span class="line">c1 <span class="type">INT</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">c2 <span class="type">VARCHAR</span>(<span class="number">10</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">KEY (c1,c2)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected, <span class="number">1</span> warning (<span class="number">0.02</span> sec)</span><br></pre></td></tr></table></figure>

<blockquote>
<ol start="15">
<li>7.1   InnoDB  Locking</li>
<li>6.1.6 InnoDB AUTO_INCREMENT Counter Initialization</li>
</ol>
</blockquote>
<h4 id="2-6-外键与锁"><a href="#2-6-外键与锁" class="headerlink" title="2.6  外键与锁"></a>2.6  外键与锁</h4><p><strong>2.6.1 外键用法</strong></p>
<p><strong>tips</strong>：目前MySQL支持外键的存储引擎有InnoDB和NDB。</p>
<p><strong>外键的作用</strong>：用来保证参照完整性。比如有两张表主表parent table和子表child table，在子表中拥有主表外键约束；你想同时干掉两张表；MySQL告诉你，没门，不给删；需要先删除约束，才能彻底删除，使用第三方工具删除表时深有体会。MySQL数据库InnoDB存储引擎完整支持外键。</p>
<p><strong>外键语法定义</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[<span class="keyword">CONSTRAINT</span> [symbol]] <span class="keyword">FOREIGN</span> KEY</span><br><span class="line">[index_name] (col_name, ...)</span><br><span class="line"><span class="keyword">REFERENCES</span> tbl_name (col_name,...)</span><br><span class="line">[<span class="keyword">ON</span> <span class="keyword">DELETE</span> reference_option]</span><br><span class="line">[<span class="keyword">ON</span> <span class="keyword">UPDATE</span> reference_option]</span><br><span class="line">reference_option:</span><br><span class="line">RESTRICT <span class="operator">|</span> CASCADE <span class="operator">|</span> <span class="keyword">SET</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NO</span> ACTION <span class="operator">|</span> <span class="keyword">SET</span> <span class="keyword">DEFAULT</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>13.1.20.5 FOREIGN KEY Constraints </p>
</blockquote>
<p><strong>示例创建</strong>一张父表（<strong>parent</strong>）和一张子表（<strong>child</strong>）：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> parent (</span><br><span class="line">id <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY (id)</span><br><span class="line">) ENGINE<span class="operator">=</span>INNODB;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> child (</span><br><span class="line">id <span class="type">INT</span>,</span><br><span class="line">parent_id <span class="type">INT</span>,</span><br><span class="line">INDEX par_ind (parent_id),  <span class="comment">-- 给parent_id添加索引</span></span><br><span class="line"><span class="keyword">FOREIGN</span> KEY (parent_id)   <span class="comment">-- parent_id设置为外键引用主表主键id</span></span><br><span class="line"><span class="keyword">REFERENCES</span> parent(id)   <span class="comment">-- 引用主表（parent）主键id</span></span><br><span class="line">) ENGINE<span class="operator">=</span>INNODB;</span><br></pre></td></tr></table></figure>



<p><strong>演示插入数据外键冲突</strong>：主表插入1条数据，在子表插入一条数据，违反外键约束，主表没有id&#x3D;2的行。<strong>此时无法级联更新</strong>。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> parent (id) <span class="keyword">VALUES</span> (<span class="number">1</span>); <span class="comment">-- 主表插入1条数据</span></span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> child (id,parent_id) <span class="keyword">VALUES</span>(<span class="number">2</span>,<span class="number">2</span>); <span class="comment">-- 在子表插入一条数据，违反外键约束，主表没有id=2的行</span></span><br><span class="line">ERROR <span class="number">1452</span> (<span class="number">23000</span>): Cannot <span class="keyword">add</span> <span class="keyword">or</span> <span class="keyword">update</span> a child <span class="type">row</span>: a <span class="keyword">foreign</span> key <span class="keyword">constraint</span> fails (`test`.`child`, <span class="keyword">CONSTRAINT</span> `child_ibfk_1` <span class="keyword">FOREIGN</span> KEY (`parent_id`) <span class="keyword">REFERENCES</span> `parent` (`id`))</span><br></pre></td></tr></table></figure>



<p><strong>演示删除数据外键冲突</strong>：有外键约束和索引，此时无法级联删除。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">DELETE</span> <span class="keyword">FROM</span> parent <span class="keyword">WHERE</span> id<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">ERROR <span class="number">1451</span> (<span class="number">23000</span>): Cannot <span class="keyword">delete</span> <span class="keyword">or</span> <span class="keyword">update</span> a parent <span class="type">row</span>: a <span class="keyword">foreign</span> key <span class="keyword">constraint</span> fails (`test`.`child`, <span class="keyword">CONSTRAINT</span> `child_ibfk_1` <span class="keyword">FOREIGN</span> KEY (`parent_id`) <span class="keyword">REFERENCES</span> `parent` (`id`))</span><br></pre></td></tr></table></figure>



<p><strong>如果想级联更新和删除</strong>，在创建子表（child）时加入CASCADE关键字。同样Oracle中也支持CASCADE，在Oracle中创建外键时注意给这个列加上索引，具体用法可能略有差异。删除原表，重新创建子表child，并加入给update与delete条件加入CASCADE属性。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> child;<span class="comment">-- 删除原有创建子表child</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 重新创建子表child，并加入给update与delete条件加入CASCADE</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> child (</span><br><span class="line">id <span class="type">INT</span>,</span><br><span class="line">parent_id <span class="type">INT</span>,</span><br><span class="line">INDEX par_ind (parent_id),</span><br><span class="line"><span class="keyword">FOREIGN</span> KEY (parent_id)</span><br><span class="line"><span class="keyword">REFERENCES</span> parent(id)</span><br><span class="line"><span class="keyword">ON</span> <span class="keyword">UPDATE</span> CASCADE</span><br><span class="line"><span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE</span><br><span class="line">) ENGINE<span class="operator">=</span>INNODB;</span><br></pre></td></tr></table></figure>



<p>子表（<strong>child</strong>）插入测试数据：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> child (id,parent_id) <span class="keyword">VALUES</span>(<span class="number">1</span>,<span class="number">1</span>),(<span class="number">2</span>,<span class="number">1</span>),(<span class="number">3</span>,<span class="number">1</span>);</span><br><span class="line">Query OK, <span class="number">3</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line">Records: <span class="number">3</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br></pre></td></tr></table></figure>



<p>更新主表（<strong>parent</strong>）id值为2：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">UPDATE</span> parent <span class="keyword">SET</span> id <span class="operator">=</span> <span class="number">2</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"><span class="keyword">Rows</span> matched: <span class="number">1</span>  Changed: <span class="number">1</span>  Warnings: <span class="number">0</span></span><br></pre></td></tr></table></figure>



<p><strong>查询验证主表</strong>（<strong>parent</strong>）：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> parent;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>



<p><strong>查询验证子表</strong>（<strong>child</strong>）的<strong>parent_id</strong>值：此时已经全部更新（update）成 2</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> child;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+-----------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span> parent_id <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+-----------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span>         <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span>         <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span>         <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+-----------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>



<p><strong>演示级联删除效果</strong>：此时可以删除数据内容</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">delete</span> <span class="keyword">from</span> parent <span class="keyword">where</span> id<span class="operator">=</span><span class="number">2</span>;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>



<p><strong>再次查看子表</strong>（<strong>child</strong>）：此时子表中的数据内容一并删除掉</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> child;</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>



<p>补充一点，如果想查看表约束，可以通过命令去验证<code>show create table table_name</code>：</p>
<p>查到子表（child）已经自动在外键列加入了索引。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> child\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">       <span class="keyword">Table</span>: child</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">Table</span>: <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `child` (</span><br><span class="line">  `id` <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `parent_id` <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  KEY `par_ind` (`parent_id`),</span><br><span class="line">  <span class="keyword">CONSTRAINT</span> `child_ibfk_1` <span class="keyword">FOREIGN</span> KEY (`parent_id`) <span class="keyword">REFERENCES</span> `parent` (`id`) <span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE <span class="keyword">ON</span> <span class="keyword">UPDATE</span> CASCADE</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4</span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>



<p><strong>注意</strong>：MySQL数据库外键是即时检查的，对每一行都会运行外键检查。导入数据，在检查外键约束上往往消耗大量时间。有时候，可以灵活处理，在导入过程中忽略外键检查：<code>set foreign_key_checks=0</code>，默认值是1，开启了外键约束检查。</p>
<p>前面列举示例进行外键功能说明，接下来配合锁进行描述。</p>
<p><strong>2.6.2 外键与锁</strong></p>
<p>在InnoDB存储引擎中，对于一个外键列，如果没有显示地（人为手动添加）对这个列添加索引，在InnoDB存储引擎会自动对其加一个索引，因此可以避免表锁。这一点比Oracle数据库做得更好，Oracle数据库使用外键时，需要人为手动给该列添加索引。</p>
<p>对于外键值插入和更新，首先需要查询父表（parent）中的记录，即select父表。但对于父表进行select操作，不是使用一致性非锁定读方式，这样会发生数据不一致问题。因此这时使用的是<code>select ... lock in share mode</code>方式（共享锁），主动给父表加一个S锁。如果父表已经加了X锁，子表操作会被阻塞。（可以在两个会话窗口进行测试）</p>
<p><strong>示例阻塞</strong>：</p>
<p>分别在session1会话和session2会话窗口执行事务。session1会话进行删除父表（parent）id为1的内容，session2会话执行插入内容到子表（child），发现session2此时发生阻塞，阻塞等待超时发出警告（默认50秒）。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- session1</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">begin</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">delete</span> <span class="keyword">from</span> parent <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- session2，阻塞等待超时发出警告（默认50秒）</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">begin</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> child <span class="keyword">select</span> <span class="number">4</span>,<span class="number">1</span>;</span><br><span class="line">ERROR <span class="number">1205</span> (HY000): Lock wait timeout exceeded; try restarting transaction</span><br></pre></td></tr></table></figure>
<p><img data-src="https://img-blog.csdnimg.cn/8018eeede19d432597ef6e5e49318029.png?x-oss-process=,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA6b6Z6IW-5LiH6YeMc2t5,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p>
<p>此时子表（child）处于锁定等待中，在<strong>MySQL8.0</strong>中可以使用<code>data_locks</code>参数进行分析：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> performance_schema.data_locks <span class="keyword">order</span> <span class="keyword">by</span> event_id <span class="keyword">desc</span> limit <span class="number">0</span>,<span class="number">1</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">               ENGINE: INNODB</span><br><span class="line">       ENGINE_LOCK_ID: <span class="number">2079935859840</span>:<span class="number">93</span>:<span class="number">5</span>:<span class="number">1</span>:<span class="number">2079912818080</span></span><br><span class="line">ENGINE_TRANSACTION_ID: <span class="number">16653</span></span><br><span class="line">            THREAD_ID: <span class="number">48</span></span><br><span class="line">             EVENT_ID: <span class="number">12</span></span><br><span class="line">        OBJECT_SCHEMA: test</span><br><span class="line">          OBJECT_NAME: child</span><br><span class="line">       PARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">    SUBPARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">           INDEX_NAME: par_ind</span><br><span class="line">OBJECT_INSTANCE_BEGIN: <span class="number">2079912818080</span></span><br><span class="line">            LOCK_TYPE: RECORD</span><br><span class="line">            LOCK_MODE: S</span><br><span class="line">          LOCK_STATUS: GRANTED</span><br><span class="line">            LOCK_DATA: supremum pseudo<span class="operator">-</span>record</span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>锁等待，在<strong>MySQL8.0</strong>中可以使用<code>data_lock_waits</code>参数进行分析：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> performance_schema.data_lock_waits  limit <span class="number">0</span>,<span class="number">1</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">                          ENGINE: INNODB</span><br><span class="line">       REQUESTING_ENGINE_LOCK_ID: <span class="number">2079935860616</span>:<span class="number">91</span>:<span class="number">4</span>:<span class="number">2</span>:<span class="number">2079912823744</span></span><br><span class="line">REQUESTING_ENGINE_TRANSACTION_ID: <span class="number">16658</span></span><br><span class="line">            REQUESTING_THREAD_ID: <span class="number">49</span></span><br><span class="line">             REQUESTING_EVENT_ID: <span class="number">10</span></span><br><span class="line">REQUESTING_OBJECT_INSTANCE_BEGIN: <span class="number">2079912823744</span></span><br><span class="line">         BLOCKING_ENGINE_LOCK_ID: <span class="number">2079935859840</span>:<span class="number">91</span>:<span class="number">4</span>:<span class="number">2</span>:<span class="number">2079912817048</span></span><br><span class="line">  BLOCKING_ENGINE_TRANSACTION_ID: <span class="number">16653</span></span><br><span class="line">              BLOCKING_THREAD_ID: <span class="number">48</span></span><br><span class="line">               BLOCKING_EVENT_ID: <span class="number">12</span></span><br><span class="line">  BLOCKING_OBJECT_INSTANCE_BEGIN: <span class="number">2079912817048</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>前面介绍锁类型也提到过<code>data_locks</code>和<code>data_lock_waits</code>这两个参数，MySQL8.0之前在information_schema架构下有<code>INNODB_LOCKS</code>、<code>INNODB_LOCK_WAITS</code>两个系统参数可以进行参考。此处进行示例，也算补足在锁类型章节没有进行示例演示。</p>
<p><strong>下面是官方对外键锁定介绍</strong>：MySQL在必要时扩展元数据锁，通过外键约束关联表。扩展元数据锁可以防止DML和DDL操作在相关表上并发执行引起的冲突。该特性还支持在父表被修改时，更新外键元数据。MySQL早期版本中，外键元数据(由子表拥有)不能安全更新。如果一个表被LOCK TABLES显式锁定，那么任何与外键约束相关的表都会被隐式打开和锁定。对于外键检查，在相关表上获取一个共享只读锁(LOCK TABLES READ)。对于级联更新，在操作涉及的相关表上获取一个无共享的写锁(LOCK TABLES WRITE)。</p>
<p>外键定义和元数据（Foreign Key Definitions and Metadata）。查看外键定义，可以使用<code>SHOW CREATE TABLE child\G</code>，之前也提到过，这里不再赘述。</p>
<p>如下是查看到数据库中哪些表使用到的外键信息，显示数据库名（<strong>TABLE_SCHEMA</strong>）、表名（<strong>TABLE_NAME</strong>）、字段列名（<strong>COLUMN_NAME</strong>）以及外键约束名（<strong>CONSTRAINT_NAME</strong>）。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> TABLE_SCHEMA, TABLE_NAME, COLUMN_NAME, CONSTRAINT_NAME</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">FROM</span> INFORMATION_SCHEMA.KEY_COLUMN_USAGE</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">WHERE</span> REFERENCED_TABLE_SCHEMA <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------+-----------------+----------------------+---------------------------+</span></span><br><span class="line"><span class="operator">|</span> TABLE_SCHEMA <span class="operator">|</span> TABLE_NAME      <span class="operator">|</span> COLUMN_NAME          <span class="operator">|</span> CONSTRAINT_NAME           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------+-----------------+----------------------+---------------------------+</span></span><br><span class="line"><span class="operator">|</span> world        <span class="operator">|</span> city            <span class="operator">|</span> CountryCode          <span class="operator">|</span> city_ibfk_1               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> world        <span class="operator">|</span> countrylanguage <span class="operator">|</span> CountryCode          <span class="operator">|</span> countryLanguage_ibfk_1    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> test         <span class="operator">|</span> child           <span class="operator">|</span> parent_id            <span class="operator">|</span> child_ibfk_1              <span class="operator">|</span></span><br><span class="line">...</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------+-----------------+----------------------+---------------------------+</span></span><br><span class="line"><span class="number">25</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.02</span> sec)</span><br></pre></td></tr></table></figure>

<p><strong>查询INFORMATION_SCHEMA架构下的INNODB_FOREIGN</strong>，使用limit查询2条记录进行演示。world数据库与sakila数据库均为MySQL官方示例，前面有官方链接，可自行获取。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> INFORMATION_SCHEMA.INNODB_FOREIGN limit <span class="number">0</span>,<span class="number">2</span> \G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">      ID: world<span class="operator">/</span>city_ibfk_1</span><br><span class="line">FOR_NAME: world<span class="operator">/</span>city</span><br><span class="line">REF_NAME: world<span class="operator">/</span>country</span><br><span class="line">  N_COLS: <span class="number">1</span></span><br><span class="line">    TYPE: <span class="number">48</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">      ID: sakila<span class="operator">/</span>fk_address_city</span><br><span class="line">FOR_NAME: sakila<span class="operator">/</span>address</span><br><span class="line">REF_NAME: sakila<span class="operator">/</span>city</span><br><span class="line">  N_COLS: <span class="number">1</span></span><br><span class="line">    TYPE: <span class="number">4</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>



<h4 id="2-7-锁的算法"><a href="#2-7-锁的算法" class="headerlink" title="2.7  锁的算法"></a>2.7  锁的算法</h4><p>在描述锁类型，我已经将InnoDB存储引擎中锁类型全部列举出来了，参考MySQL8.0-refman第15章节：15.7.1 InnoDB Locking。</p>
<p><strong>2.7.1 行锁的3种算法</strong></p>
<p>InnoDB存储引擎有3种行锁算法：</p>
<ol>
<li>Record Locks：单个行记录上的锁；</li>
<li>Gap Locks：间隙锁，锁定一个范围，不包含记录本身；</li>
<li>Next-Key Locks：Record Locks和Gap Locks，锁定一个范围，并且锁定记录本身。</li>
</ol>
<p><code>Record Locks</code>记录锁总是锁定索引记录。即使表没有定义索引，对于这种情况InnoDB会创建一个隐藏的聚集索引，并使用这个索引进行记录锁定。</p>
<p><code>Next-Key Locks</code>是结合了Record Locks和Gap Locks的一种锁定算法，在Next-Key Locks算法下，InnoDB对于行的查询都是采用这种锁定算法。</p>
<p>InnoDB执行行级锁的方式是这样的：当它搜索或扫描一个表索引时，它会在遇到的索引记录上设置共享或排它锁。因此，行级锁实际上是索引记录锁。索引记录上的next-key锁也会影响该索引记录之前的间隙。也就是说，next-key锁是索引记录锁加上索引记录之前的间隙锁。如果一个会话对索引中的记录R有一个共享或排它锁，那么另一个会话不能在紧挨着索引顺序的R之前的间隙插入一个新索引记录。</p>
<p>假设一个索引包含值10、11、13和20。此索引可能的next-key锁覆盖以下区间，其中圆括号表示排除区间端点，方括号表示包含端点：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(negative infinity, 10]</span><br><span class="line">(10, 11]</span><br><span class="line">(11, 13]</span><br><span class="line">(13, 20]</span><br><span class="line">(20, positive infinity)</span><br></pre></td></tr></table></figure>

<p>如果事务T1已经通过<code>Next-Key Locks</code>锁定如下范围：</p>
<p>(10, 11]、(11, 13]</p>
<p>当插入新记录12时，锁定范围会变成：</p>
<p>(10, 11]、(11,12]、(12, 13]</p>
<p>当查询的索引包含唯一属性时，InnoDB存储引擎会对<code>Next-Key Locks</code>进行优化，将其降级为<code>Record Locks</code>，仅锁住索引本身，而不是范围。在InnoDB存储引擎中，对于insert操作，会检查插入记录的一条记录是否被锁定，如果已经被锁定，则不允许查询。</p>
<p><strong>2.7.2 解决Phantom Problem</strong></p>
<p><strong>什么是Phantom Problem</strong>？：指在同一事务中，连续执行两次同样的SQL语句可能导致不同的结果，第二次执行的SQL语句可能返回之前不存在的行。</p>
<p><strong>目的</strong>：解决数据一致性。你可以联想到幻读、脏读、更新丢失，其实也是为了解决数据一致性问题。</p>
<p>当同一查询在不同时间产生不同的行集时，就会在事务中出现所谓的幻影问题。例如，如果一个SELECT被执行了两次，但是第二次返回了第一次没有返回的一行，那么该行就是一个幻像行。</p>
<p>假设子表的id列上有一个索引，您希望读取和锁定表中标识符值大于100的所有行，以便稍后更新选中行的某些列：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> child <span class="keyword">WHERE</span> id <span class="operator">&gt;</span> <span class="number">100</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure>

<p>查询从 id 大于 100 的第一条记录开始扫描索引。让表包含 id 值为 90 和 102 的行。如果在扫描的索引记录上设置的锁范围不锁定间隙锁记录（在这种情况下，90 和 102 之间的间隙记录），另一个 session 可以在表中插入id 为101的新行。如果在同一个事务中，要执行相同的 SELECT，此时查询返回，会在结果集中看到一个 id 为 101 的新行（幻像） 。如果将一组行视为一个数据项，则新的幻像将违反 一个事务运行的事务隔离原则，以便它拥有的数据 （read 操作） 在事务期间不会改变。</p>
<p>InnoDB存储引擎提供了SQL92标准所描述的四种事务隔离级别：</p>
<ul>
<li>READ UNCOMMITTED：未提交读</li>
<li>READ COMMITTED：已提交读</li>
<li>REPEATABLE READ ：可重复读</li>
<li>SERIALIZABLE：可串行化（序列化）</li>
</ul>
<p><strong>而InnoDB默认事务隔离级别是REPEATABLE READ</strong>，通过如下命令可以查询到。transaction_isolation系统参数是动态的，可以在数据库运行过程中进行调整测试，你也可以在不同会话中测试不同事务隔离级别。</p>
<p>当然，你还可以在my.ini或者my.cnf配置文件中设置测试：<code>transaction-isolation=name</code>，name为上面介绍的事务隔离级别</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> @<span class="variable">@transaction_isolation</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@transaction_isolation</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+</span></span><br><span class="line"><span class="operator">|</span> REPEATABLE<span class="operator">-</span>READ         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>



<p>为了解决phantoms problem，InnoDB使用了一种称为next-key locking锁的算法，它结合了索引行锁（index-row<br>locking ）和间隙锁（Gap Locks）。InnoDB执行行级锁的方式是这样的：当它搜索或扫描一个表索引时，它会在遇到的索引记录上设置共享或排它锁。因此，行级锁实际上是索引记录锁。此外，索引记录上的next-key锁也会影响索引记录之前的间隙。也就是说，next-key锁是索引记录锁加上索引记录之前的间隙锁。</p>
<p>当InnoDB扫描一个索引时，它也可以锁定索引中最后一条记录之后的间隙。就像上面的例子中所发生的那样：为了防止表中插入任何id大于100的行，InnoDB设置的锁包含了id值102后面的一个锁。</p>
<p>你可以在应用程序中使用next-key locking来实现唯一性检查：如果阅读了共享模式下的数据，并且看不到要插入行的重复项（看不到幻象），那么可以安全地插入行，并知道读取期间在行的后续设置的next-key locking锁，防止任何人同时在你所使用的行插入重复项。因此，next-key锁定能够锁定表中不存在的内容。</p>
<p>可以禁用间隙锁定，这可能会导致幻象问题，因为当间隙锁定被禁用时，其它会话可能会将新行插入到间隙中。</p>
<p>个人理解难免有些不到位，如果给你带来误解，我表示抱歉。你可以找到参考文档：</p>
<blockquote>
<p>15.7.4 Phantom Rows</p>
</blockquote>
<p>同时你还可以参考这本书籍《MySQL技术内幕InnoDB存储引擎 第2版》，如果作者能针对MySQL8.0进行更新就好了。虽然过去快10年了，依然是一本经典书籍，颇有参考意义，便于理解InnoDB。</p>
<h4 id="2-8-阻塞、死锁、锁升级"><a href="#2-8-阻塞、死锁、锁升级" class="headerlink" title="2.8  阻塞、死锁、锁升级"></a>2.8  阻塞、死锁、锁升级</h4><p><strong>2.8.1 阻塞</strong></p>
<p>如何理解阻塞，想象一下有东西被堵住了，如何处理。</p>
<p><strong>数据库中阻塞</strong>：因为不同锁之间的兼容性关系，在某些时刻一个事务中的锁需要等待另一事务中的锁释放它所占用的资源，这就是阻塞。阻塞并不是一件坏事，为了保证事务并发并且正常运行。</p>
<p>在InnoDB存储引擎中，控制阻塞等待时间参数<code>innodb_lock_wait_timeout</code>，默认值为50秒。</p>
<p><strong>查询示例</strong>：说明一下，在文中多次用到select @@系统参数查询。当然，在官方文档中也有参数说明。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> @<span class="variable">@innodb_lock_wait_timeout</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@innodb_lock_wait_timeout</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------+</span></span><br><span class="line"><span class="operator">|</span>                         <span class="number">50</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p><strong>临时设置</strong>生效，如下：</p>
<p>查看文档，参数时是动态的，在数据库运行时是可以修改的。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> @<span class="variable">@innodb_lock_wait_timeout</span><span class="operator">=</span><span class="number">60</span>; <span class="comment">-- set和@符号之间可以不加空格</span></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>如果想永久生效，可以在my.ini或者my.cnf中加入参数<code>innodb-lock-wait-timeout</code>&#x3D;#（例如设置60），重启服务生效。</p>
<p>此外，还有一个参数<code>innodb_rollback_on_timeout</code>用于设定是否在等待超时时对进行中的事务进行回滚操作。默认值是OFF，查询出来值是0，代表不回滚。查询示例如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> @<span class="variable">@innodb_rollback_on_timeout</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@innodb_rollback_on_timeout</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------+</span></span><br><span class="line"><span class="operator">|</span>                            <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>查看文档，由于非动态是非动态，在数据库运行时，不允许被更改。一旦更改，会提示参数只读。</p>
<p>关于参数是不是动态，看文档参数说明<strong>Dynamic</strong>值（YES代表动态，NO为非动态），默认值参数说明为Default Value。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> @<span class="variable">@innodb_rollback_on_timeout</span><span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">ERROR <span class="number">1238</span> (HY000): Variable <span class="string">&#x27;innodb_rollback_on_timeout&#x27;</span> <span class="keyword">is</span> a read <span class="keyword">only</span> variable</span><br></pre></td></tr></table></figure>

<p><strong>当发生超时，MySQL数据库会抛出异常ERROR 1205</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">begin</span></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> world.city <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span> <span class="keyword">for</span> <span class="keyword">update</span>;</span><br><span class="line">ERROR <span class="number">1205</span> (HY000): Lock wait timeout exceeded; try restarting transaction</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：在默认情况下InnoDB存储引擎不会回滚超时引发的错误异常。InnoDB存储引擎在绝大多数情况下，都不会对异常进行回滚。</p>
<blockquote>
<p>15.14 InnoDB Startup Options and System Variables</p>
</blockquote>
<p><strong>2.8.2 死锁</strong></p>
<p><strong>死锁概念</strong>：死锁是指两个或两个以上的事务在执行过程中，因争夺锁资源而造成的一种互相等待现象。如果没有外力作用，事务将无法推进。解决死锁问题最直接方式是不等待，将任何等待转换为回滚，并且事务重新开始。这种做法确实可以避免死锁产生，但在线上环境中，这可能导致并发性能下降，甚至任何一个事务都不能进行。带来的问题，比死锁更严重，很难发现问题并浪费资源。</p>
<p><strong>解决死锁问题最简单一种方法是超时</strong>，当两个事务互相等待时，等待时间超过系统参数设置阈值时，其中一个事务进行回滚，另一个等待的事务继续进行。在InnoDB存储引擎中，参数innodb_rollback_on_timeout用来设置超时时间，前面讲解阻塞提到过。</p>
<p>超时机制是一种简单解决方法，仅通过超时后对事务进行回滚处理，或者是根据First In，First Out（FIFO），一进一出顺序选择回滚对象。如果超时事务所占权重比较大，事务操作更新很多行，占用较多undo log，这时采用FIFO方式并不那么合适。回滚事务时间相对一个事务所占用时间会更多。</p>
<p>除了超时机制，可寻求其它解决方案。当前数据库普遍采用<strong>wait-for graph</strong>（等待图）方式，主动检测死锁，判断是否存在回路。要求数据库保存以下两种信息：</p>
<ul>
<li>锁信息链表；</li>
<li>事务等待链表。</li>
</ul>
<p>等待图方式是之前版本中的一种，当然也还有新的处理方式。</p>
<p><strong>CATS算法</strong>通过分配一个调度权重对等待的事务进行优先级排序，该权重是根据一个事务块的事务数量计算出来的。例如，如果两个事务正在等待同一个对象上的一个锁，那么阻塞最多事务的事务将被分配更大的调度权重。如果权值相等，则优先级为等待时间最长的事务。</p>
<p>在MySQL 8.0.20之前，InnoDB也使用先进先出(FIFO)算法来调度事务，CATS算法只在重锁争用的情况下使用。MySQL 8.0.20中的CATS算法增强使FIFO算法冗余，允许删除它。之前由FIFO算法执行的事务调度是由MySQL 8.0.20的CATS算法执行的。在某种情况下，此更改可能会影响授予事务锁的顺序。</p>
<p><strong>注意</strong>：MySQL8.0.20后，新版InnoDB使用争用感知事务调度(CATS)算法对等待锁的事务进行优先级排序。当多个事务在同一个对象上等待一个锁时，CATS算法确定哪个事务首先接收这个锁。</p>
<blockquote>
<p>15.7.6 Transaction Scheduling</p>
</blockquote>
<p><strong>死锁概率</strong>：</p>
<p>一般而言，死锁概率应该发生非常少，如果经常发生，系统是不可用的。</p>
<p>死锁次数，应该少于等待，至少需要两次等待才会产生一次死锁。</p>
<ol>
<li>一定环境下，系统事务数量越多，发生死锁概率越大；</li>
<li>每个事务操作数量越多，发生死锁概率越大；</li>
<li>操作数据集合越小，发生死锁概率越大。</li>
</ol>
<p><strong>死锁示例</strong>：</p>
<p>如果程序是串行的，那么不可能发生死锁，比如MyISAM存储引擎不会出现死锁，要么全部获取，要么全不获取。死锁只存在于并发情况下，数据库本身是一个并发运行程序，可能会发生死锁。</p>
<p>具体SQL语句就不贴出来，可以参考上面使用进行模拟场景。在两个会话窗口session A和session B中进行执行获取排它锁，<strong>注意执行之前使用begin开始事务</strong>。</p>
<p>死锁原因：两个会话资源互相等待。大多数死锁InnoDB存储引擎可以侦测到，无需人为进行干预。发现死锁，InnoDB存储引擎会立刻回滚一个事务。</p>
<p>在Oracle数据库中产生死锁常见原因是没有对外键添加索引，而MySQL数据库InnoDB存储引擎会自动为外键上索引，避免这种情况发生。人为删除外键索引，MySQL会抛出一个异常。</p>
<p><strong>2.8.3 锁升级</strong></p>
<p>锁升级（lock escalation）是指将当前锁粒度降低。</p>
<p>打个比方，数据库可以将1000个行锁升级为一个页锁，或者将页锁升级为表锁。如果数据库设计人为锁是一种稀有资源，想避免锁开销，数据库中会频繁出现锁升级。</p>
<p><strong>注意</strong>：MySQL中InnoDB事务模型目标是将多版本数据库（MVCC）最佳特性与传统两阶段锁结合起来。InnoDB在行级执行锁定，默认情况下以非锁定的一致读取方式运行查询，这是Oracle的风格。InnoDB中的锁信息被有效地存储在空间中，因此不需要锁升级。通常，允许多个用户锁定InnoDB表中的每一行，或者任意随机的行子集，而不会导致InnoDB内存耗尽。</p>
<blockquote>
<p>15.7 InnoDB Locking and Transaction Model</p>
</blockquote>
<h3 id="03-MySQL官方示例数据库"><a href="#03-MySQL官方示例数据库" class="headerlink" title="03  MySQL官方示例数据库"></a>03  MySQL官方示例数据库</h3><p>在对MySQL进行举例并使用到示例数据库：大多数情况使用MySQL官方提供的sakila（模拟电影出租信息管理系统）和world数据库，类似于Oracle的scott用户。</p>
<p><strong>sakila-db数据库</strong>包含三个文件，便于大家获取与使用：</p>
<ol>
<li>sakila-schema.sql：数据库表结构；</li>
<li>sakila-data.sql：数据库示例模拟数据；</li>
<li>sakila.mwb：数据库物理模型，在MySQL workbench中可以打开查看。</li>
</ol>
<blockquote>
<p><span class="exturl" data-url="aHR0cHM6Ly9kb3dubG9hZHMubXlzcWwuY29tL2RvY3Mvc2FraWxhLWRiLnppcA==">https://downloads.mysql.com/docs/sakila-db.zip<i class="fa fa-external-link-alt"></i></span></p>
</blockquote>
<p><strong>world-db数据库</strong>，包含三张表：city、country、countrylanguage。</p>
<p><strong>只是用于用于简单测试学习，建议使用world-db</strong>：</p>
<blockquote>
<p><span class="exturl" data-url="aHR0cHM6Ly9kb3dubG9hZHMubXlzcWwuY29tL2RvY3Mvd29ybGQtZGIuemlw">https://downloads.mysql.com/docs/world-db.zip<i class="fa fa-external-link-alt"></i></span></p>
</blockquote>
<p><strong>参考资料&amp;鸣谢</strong>：</p>
<blockquote>
<p>《深入浅出MySQL 第2版 数据库开发、优化与管理维护》。</p>
</blockquote>
<blockquote>
<p>《MySQL技术内幕InnoDB存储引擎 第2版》。</p>
</blockquote>
<blockquote>
<p>MySQL8.0官网文档：refman-8.0-en.pdf，如果学习新版本，官方文档是非常不错的选择。</p>
</blockquote>
<p>虽然书籍年份比较久远（停留在MySQL5.6.x版本），但仍然具有借鉴意义。</p>
<p>最后，对以上书籍和官方文档所有作者表示衷心感谢。让我充分体会到：前人栽树，后人乘凉。</p>
<h1 id="莫问收获，但问耕耘"><a href="#莫问收获，但问耕耘" class="headerlink" title="莫问收获，但问耕耘"></a>莫问收获，但问耕耘</h1><p><strong>能看到这里的，都是帅哥靓妹</strong>。以上是本次MySQL优化篇（上部分）全部内容，希望能对你的工作与学习有所帮助。感觉写的好，就拿出你的一键三连。如果感觉总结的不到位，也希望能留下您宝贵的意见，我会在文章中定期进行调整优化。<strong>好记性不如烂笔头，多实践多积累</strong>。<strong>你会发现，自己的知识宝库越来越丰富</strong>。原创不易，转载也请标明出处和作者，尊重原创。</p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>龙腾万里sky
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://blog.cnwangk.top/2022/04/07/MySQL%E9%94%81%E9%97%AE%E9%A2%98InnoDB%E9%94%81%EF%BC%9A%E8%A1%8C%E9%94%81%E3%80%81lock%E4%B8%8Elatch%E3%80%81%E5%A4%96%E9%94%AE%E4%B8%8E%E9%94%81%E3%80%81%E9%94%81%E7%AE%97%E6%B3%95%E4%BB%A5%E5%8F%8A%E6%AD%BB%E9%94%81%E9%97%AE%E9%A2%98/" title="MySQL锁问题InnoDB锁：行锁、lock与latch、外键与锁、锁算法以及死锁问题">https://blog.cnwangk.top/2022/04/07/MySQL锁问题InnoDB锁：行锁、lock与latch、外键与锁、锁算法以及死锁问题/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</span> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="followme">
  <span>欢迎关注我的其它发布渠道</span>

  <div class="social-list">

      <div class="social-item">
          <span class="social-link">
            <span class="icon">
              <i class="fab fa-weixin"></i>
            </span>

            <span class="label">WeChat</span>
          </span>

          <img class="social-item-img" src="/images/wechat_channel.jpg">
      </div>

      <div class="social-item">
          <a target="_blank" class="social-link" href="https://www.zhihu.com/people/hbwk">
            <span class="icon">
              <i class="fab fa-zhihu"></i>
            </span>

            <span class="label">Zhihu</span>
          </a>
      </div>
  </div>
</div>

          <div class="post-tags">
              <a href="/tags/MySQL/" rel="tag"><i class="fa fa-tag"></i> MySQL</a>
          </div>

        
  <div class="social-like a2a_kit a2a_kit_size_32 a2a_default_style">
    <a class="a2a_dd" target="_blank" rel="noopener" href="https://www.addtoany.com/share"></a>
      <a class="a2a_button_facebook"></a>
      <a class="a2a_button_twitter"></a>
  </div>

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/03/20/Windows-10%E5%B9%B3%E5%8F%B0%E5%AE%89%E8%A3%85PostgreSQL-14-2%E8%AF%A6%E7%BB%86%E6%95%99%E7%A8%8B/" rel="prev" title="Windows 10平台安装PostgreSQL 14.2详细教程">
                  <i class="fa fa-angle-left"></i> Windows 10平台安装PostgreSQL 14.2详细教程
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/04/07/MySQL%E9%94%81%E9%97%AE%E9%A2%98%EF%BC%9AMyISAM%E5%8A%A0%E8%A1%A8%E9%94%81%E3%80%81%E5%B9%B6%E5%8F%91%E6%8F%92%E5%85%A5%E4%BB%A5%E5%8F%8A%E9%94%81%E8%B0%83%E5%BA%A6/" rel="next" title="MySQL锁问题：MyISAM加表锁、并发插入以及锁调度">
                  MySQL锁问题：MyISAM加表锁、并发插入以及锁调度 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  
  <div class="comments giscus-container">
  </div>
  
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2017 – 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Copyright © 龙腾万里sky. All Rights Reserved.</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">257k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">15:33</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        本站访客数：  <span id="busuanzi_value_site_uv"></span> 人次
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        本站总访问量： <span id="busuanzi_value_site_pv"></span> 次
      </span>
    </span>
</div>
  <div class="powered-by">由 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl" data-url="aHR0cHM6Ly90aGVtZS1uZXh0LmpzLm9yZw==">NexT.Gemini</span> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL2Nud2FuZ2s=" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></span>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.7.0/mermaid.min.js","integrity":"sha256-TtLOdUA8mstPoO6sGvHIGx2ceXrrX4KgIItO06XOn8A="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>



  <script src="/js/third-party/pace.js"></script>

  <script src="/js/third-party/addtoany.js"></script>

  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  <script src="https://cdnjs.cloudflare.com/ajax/libs/quicklink/2.3.0/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous"></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":3000,"priority":true,"url":"https://blog.cnwangk.top/2022/04/07/MySQL%E9%94%81%E9%97%AE%E9%A2%98InnoDB%E9%94%81%EF%BC%9A%E8%A1%8C%E9%94%81%E3%80%81lock%E4%B8%8Elatch%E3%80%81%E5%A4%96%E9%94%AE%E4%B8%8E%E9%94%81%E3%80%81%E9%94%81%E7%AE%97%E6%B3%95%E4%BB%A5%E5%8F%8A%E6%AD%BB%E9%94%81%E9%97%AE%E9%A2%98/"}</script>
  <script src="/js/third-party/quicklink.js"></script>
<script class="next-config" data-name="giscus" type="application/json">{"enable":true,"repo":"cnwangk/blog-talk","repo_id":"R_kgDOJg6bLQ","category":"Announcements","category_id":"DIC_kwDOJg6bLc4CWXpT","mapping":"pathname","reactions_enabled":1,"emit_metadata":1,"theme":"light","lang":"zh-CN","crossorigin":"anonymous","input_position":"bottom","loading":"lazy"}</script>

<script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.page.comments) return;

  NexT.utils.loadComments('.giscus-container')
    .then(() => NexT.utils.getScript('https://giscus.app/client.js', {
      attributes: {
        async                   : true,
        crossOrigin             : 'anonymous',
        'data-repo'             : CONFIG.giscus.repo,
        'data-repo-id'          : CONFIG.giscus.repo_id,
        'data-category'         : CONFIG.giscus.category,
        'data-category-id'      : CONFIG.giscus.category_id,
        'data-mapping'          : CONFIG.giscus.mapping,
        'data-reactions-enabled': CONFIG.giscus.reactions_enabled,
        'data-emit-metadata'    : CONFIG.giscus.emit_metadata,
        'data-theme'            : CONFIG.giscus.theme,
        'data-lang'             : CONFIG.giscus.lang,
        'data-input-position'   : CONFIG.giscus.input_position,
        'data-loading'          : CONFIG.giscus.loading
      },
      parentNode: document.querySelector('.giscus-container')
    }));
});
</script>

</body>
</html>
